<!-- team/templates/team/team_member_form.html -->
{% extends 'base.html' %} {% block content %}
<div class="text-right mb-4">
  <a
    href="{% url 'team_member_list' %}"
    class="text-gray-400 hover:text-blue-600"
    >Back to List</a>
</div>
<h2 class="text-2xl font-bold mb-1">
  {% if object %}Edit{% else %}Add a{% endif %} Team Member
</h2>
<p class="text-slate-400 text-sm mb-4 pb-4 border-b border-solid border-color-gray-75">
  Set contact info and role
</p>
<form method="post" class="space-y-4">
  {% csrf_token %}
  <h2 class="text-xl font-bold mb-1">
    Info
  </h2>
  {% for field in form %}
    {% if field.is_hidden %}
      {{ field }}
    {% else %}
      <div class="flex flex-col">
        {% if field.html_name != 'role' %}
          <input
            type="{{ field.field.widget.input_type }}"
            name="{{ field.html_name }}"
            id="{{ field.id_for_label }}"
            placeholder="{{ field.label }}"
            value="{{ field.value|default_if_none:'' }}"
            class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
            {% if field.field.required %}required{% endif %}
          />
        {% endif %}
      </div>
    {% endif %}
  {% endfor %}

  <h2 class="text-xl font-bold mb-1">
    Role
  </h2>

  {% for value, label in form.role.field.choices %}
    <div class="flex flex-col pb-4 border-b border-solid border-gray-200">
      <label class="role-label flex items-center justify-between text-gray-400 hover:text-blue-600">
        <span class="text-sm">{{ label }}</span>
        <input type="radio" name="role" value="{{ value }}" 
          class="form-radio h-5 w-5" 
          {% if form.role.value == value or form.role.value is None and forloop.first %} checked {% endif %}
          onchange="handleRadioChange(this)"
        >
      </label>
    </div>

    <script>
      function handleRadioChange(radio) {
        document.querySelectorAll('.role-label').forEach(label => {
          label.classList.replace('text-gray-700', 'text-gray-400');
        });
    
        if (radio.checked) {
          radio.parentElement.classList.replace('text-gray-400', 'text-gray-700');
        }
      }
      
      // Initialize the labels on document load
      window.addEventListener('DOMContentLoaded', (event) => {
        document.querySelectorAll('input[name="role"]:checked').forEach(radio => {
          handleRadioChange(radio);
        });
      });
    </script>
  {% endfor %}
  
  {% if form.errors %}
    <div class="text-red-500 text-sm mt-2 bg-red-100 p-2 border border-solid border-red-500 rounded-md">
      {% for field in form %}
        {% for error in field.errors %}
          <p>{{ error }}</p>
        {% endfor %}
      {% endfor %}
    </div>
  {% endif %}

  <div class="flex justify-between pt-4">
    <div>
      {% if object %}
        <input type="button" id="delete" value="Delete" class="px-4 py-2 font-bold rounded border border-red-300 text-red-500 hover:bg-red-100 hover:cursor-pointer" />
      {% endif %}
    </div>
    <div>
      <input type="submit" value="Save" class="px-4 py-2 font-bold text-white bg-blue-500 rounded hover:bg-blue-700 hover:cursor-pointer" />
    </div>
  </div>
</form>

<script>
  var selector = document.getElementById("id_phone");
  var im = new Inputmask("(999) 999-9999");
  im.mask(selector);
</script>

{% if object %}
<script>
  let deleteButton = document.getElementById("delete");
  deleteButton.addEventListener('click', function() {
    Swal.fire({
        title: 'Delete Team Member?',
        text: 'Are you sure you want to delete this team member?',
        confirmButtonText: 'Yes',
        showCancelButton: true,
        confirmButtonColor: 'rgb(59 130 246)',
    }).then((result) => {
      const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
      if (result.isConfirmed) {
        fetch("{% url 'team_member_delete' object.pk %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if(data.status === 'success') {
                window.location.href = "/";
            } else {
              Swal.fire({
                  title: 'Error',
                  text: 'Failed to delete member',
                  confirmButtonText: 'OK',
                  icon: "error"
              })
            }
        })
        .catch(error => Swal.fire({
                  title: 'Error',
                  text: error,
                  confirmButtonText: 'OK',
                  icon: "error"
              }));
      }
    });
  });
</script>
{% endif %}
{% endblock %}
